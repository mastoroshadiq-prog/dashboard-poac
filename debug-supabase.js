/**
 * DEBUG SCRIPT - Cek Koneksi & Tabel Supabase
 * 
 * Script ini akan mengecek:
 * 1. Koneksi ke Supabase
 * 2. Apakah tabel spk_header ada
 * 3. Apakah tabel master_pihak ada dan punya data
 * 4. Test INSERT sederhana
 */

require('dotenv').config();
const { supabase } = require('./config/supabase');

async function debugSupabase() {
  console.log('ğŸ” DEBUG: Supabase Connection & Tables');
  console.log('='.repeat(60));
  
  // 1. Cek Environment Variables
  console.log('\n1ï¸âƒ£ Environment Variables:');
  console.log('   SUPABASE_URL:', process.env.SUPABASE_URL ? 'âœ… Set' : 'âŒ NOT SET');
  console.log('   SUPABASE_KEY:', process.env.SUPABASE_KEY ? 'âœ… Set' : 'âŒ NOT SET');
  
  if (!process.env.SUPABASE_URL || !process.env.SUPABASE_KEY) {
    console.log('\nâŒ FATAL: File .env tidak dikonfigurasi dengan benar!');
    console.log('   Pastikan ada file .env dengan isi:');
    console.log('   SUPABASE_URL=https://your-project.supabase.co');
    console.log('   SUPABASE_KEY=your-anon-key');
    return;
  }
  
  // 2. Test Koneksi Supabase
  console.log('\n2ï¸âƒ£ Test Koneksi Supabase:');
  try {
    const { data, error } = await supabase.from('master_pihak').select('count');
    
    if (error) {
      console.log('   âŒ Koneksi GAGAL:', error.message);
      console.log('   Error Code:', error.code);
      console.log('   Hint:', error.hint);
    } else {
      console.log('   âœ… Koneksi BERHASIL!');
    }
  } catch (err) {
    console.log('   âŒ Error:', err.message);
  }
  
  // 3. Cek Tabel master_pihak
  console.log('\n3ï¸âƒ£ Cek Tabel master_pihak:');
  try {
    const { data, error } = await supabase
      .from('master_pihak')
      .select('*')
      .limit(5);
    
    if (error) {
      console.log('   âŒ Tabel master_pihak ERROR:', error.message);
      console.log('   Kemungkinan: Tabel belum dibuat atau RLS blocking');
    } else {
      console.log('   âœ… Tabel master_pihak ADA!');
      console.log('   Jumlah data (max 5):', data?.length || 0);
      if (data && data.length > 0) {
        console.log('   Sample ID Pihak:', data[0].id_pihak);
        console.log('\n   ğŸ“‹ Semua ID Pihak yang tersedia:');
        data.forEach((pihak, idx) => {
          console.log(`      ${idx + 1}. ${pihak.id_pihak} (${pihak.nama_pihak || 'No Name'})`);
        });
      } else {
        console.log('   âš ï¸  Tabel KOSONG! Tidak ada data untuk test.');
      }
    }
  } catch (err) {
    console.log('   âŒ Error:', err.message);
  }
  
  // 4. Cek Tabel spk_header
  console.log('\n4ï¸âƒ£ Cek Tabel spk_header:');
  try {
    const { data, error } = await supabase
      .from('spk_header')
      .select('*')
      .limit(5);
    
    if (error) {
      console.log('   âŒ Tabel spk_header ERROR:', error.message);
      console.log('   Kemungkinan: Tabel belum dibuat!');
      console.log('\n   ğŸ’¡ SOLUSI: Buat tabel dulu di Supabase SQL Editor:');
      console.log('      CREATE TABLE spk_header (');
      console.log('        id_spk uuid DEFAULT gen_random_uuid() PRIMARY KEY,');
      console.log('        nama_spk varchar(255) NOT NULL,');
      console.log('        id_asisten_pembuat varchar(50) NOT NULL,');
      console.log('        tanggal_dibuat timestamptz DEFAULT now() NOT NULL,');
      console.log('        tanggal_target_selesai date NULL,');
      console.log('        status_spk varchar(20) DEFAULT \'BARU\' NOT NULL,');
      console.log('        keterangan text NULL');
      console.log('      );');
    } else {
      console.log('   âœ… Tabel spk_header ADA!');
      console.log('   Jumlah data:', data?.length || 0);
      if (data && data.length > 0) {
        console.log('\n   ğŸ“‹ Data SPK yang sudah ada:');
        data.forEach((spk, idx) => {
          console.log(`      ${idx + 1}. ${spk.nama_spk} (Status: ${spk.status_spk})`);
        });
      }
    }
  } catch (err) {
    console.log('   âŒ Error:', err.message);
  }
  
  // 5. Test INSERT sederhana ke spk_header
  console.log('\n5ï¸âƒ£ Test INSERT ke spk_header:');
  try {
    // Ambil ID pihak pertama yang ada
    const { data: pihakData } = await supabase
      .from('master_pihak')
      .select('id_pihak')
      .limit(1)
      .single();
    
    if (!pihakData) {
      console.log('   âš ï¸  SKIP: Tidak ada data di master_pihak untuk test');
    } else {
      console.log('   Menggunakan ID Pihak:', pihakData.id_pihak);
      
      const testData = {
        nama_spk: 'DEBUG TEST - ' + new Date().toISOString(),
        id_asisten_pembuat: pihakData.id_pihak,
        keterangan: 'Auto-generated by debug script'
      };
      
      console.log('   Mencoba INSERT...');
      const { data, error } = await supabase
        .from('spk_header')
        .insert([testData])
        .select();
      
      if (error) {
        console.log('   âŒ INSERT GAGAL:', error.message);
        console.log('   Error Details:', JSON.stringify(error, null, 2));
        
        // Cek apakah RLS yang blocking
        if (error.code === '42501' || error.message.includes('policy')) {
          console.log('\n   ğŸ’¡ KEMUNGKINAN: Row Level Security (RLS) blocking!');
          console.log('      SOLUSI 1: Disable RLS untuk tabel spk_header:');
          console.log('        ALTER TABLE spk_header DISABLE ROW LEVEL SECURITY;');
          console.log('\n      SOLUSI 2: Buat policy untuk anonymous access:');
          console.log('        CREATE POLICY "Allow anonymous insert" ON spk_header');
          console.log('        FOR INSERT TO anon WITH CHECK (true);');
        }
      } else {
        console.log('   âœ… INSERT BERHASIL!');
        console.log('   ID SPK Baru:', data[0].id_spk);
        console.log('   Status:', data[0].status_spk);
        console.log('   Tanggal Dibuat:', data[0].tanggal_dibuat);
        console.log('\n   ğŸ‰ Data berhasil masuk ke Supabase!');
      }
    }
  } catch (err) {
    console.log('   âŒ Error:', err.message);
  }
  
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ Debug selesai!');
  console.log('');
}

// Jalankan debug
debugSupabase().catch(err => {
  console.error('ğŸ’¥ Fatal error:', err);
});
